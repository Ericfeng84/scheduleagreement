这是一个基于 Spring Boot 实现您描述的 Schedule Agreement (计划协议) 模块的方案。它将包含以下核心功能：

1.  **创建计划协议 (Schedule Agreement)**:
    *   定义客户、物料、总体承诺数量 (Target Quantity) 等基本信息。
2.  **提交客户需求 (Demand)**:
    *   用户可以为特定的计划协议提交需求（数量和期望日期）。
    *   这代表了客户对未来购买量的承诺。
3.  **计算累计需求**:
    *   系统自动根据客户提交的需求，计算特定计划协议下的总需求量（通常按物料和客户）。
4.  **提交交货计划 (Delivery Plan)**:
    *   客户或系统可以为计划协议提交具体的交货计划（包含数量和计划交货日期）。
5.  **确认/拆分/延迟 交货计划**:
    *   这是处理交货计划提交的核心逻辑，确保交货计划不超过当月可承诺量。具体流程如下：
        *   **触发**: 当客户提交一个交货计划时，系统会执行此检查。
        *   **按月检查**: 关注该交货计划的计划交货日期所在的月份。
        *   **计算关键指标（截止到该月底）**:
            *   **累计需求量**: 计算到该月底为止，所有客户需求的累计总量。
            *   **累计计划量**: 计算到该月底为止，该计划协议下所有状态为 `PLANNED` 或 `DEFERRED` 的交货计划的总量。
            *   **当月可承诺量**: `累计需求量` - `累计计划量`。这代表了在本月还能再接受多少新的交货计划数量。
        *   **处理当前提交的计划**: 假设当前提交的交货计划数量为 `N`。
            *   **如果 `N` 小于等于 `当月可承诺量`**: 那么整个数量 `N` 被确认，按原计划日期排入，状态设为 `PLANNED`。
            *   **如果 `N` 大于 `当月可承诺量`**:
                *   只有 `当月可承诺量` 的部分会被确认，按原计划日期排入，状态设为 `PLANNED`。
                *   剩余的 `N` - `当月可承诺量` 的数量，会被**延迟**。
                *   延迟的部分将被创建一个新的交货计划条目，数量为剩余数量，计划日期设为**下个月的一号**，状态设为 `DEFERRED`。
        *   **递归处理延迟**: 上述延迟创建的新条目（数量为 `N` - `当月可承诺量`，日期设为下个月一号）将再次进入此“确认/拆分/延迟”的检查流程。系统会检查下个月的 `累计需求量` 和 `累计计划量` 来计算下个月的 `当月可承诺量`，并决定这部分延迟的数量是完全排入下个月，还是需要进一步延迟到再下个月的一号，以此类推，直到所有数量都被排入计划或标记为延迟到未来的某个日期。

